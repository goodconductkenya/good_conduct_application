<!DOCTYPE html>
<html>
<head>
  <title>Good Conduct Certificate Application</title>
  <script src="https://cdn.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button { padding: 10px; width: 100%; margin: 8px 0; }
    .hidden { display: none; }
    .section { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; }
  </style>
</head>
<body>

<h2>Login or Register</h2>
<div id="auth-section">
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</div>

<div id="app-section" class="hidden">
  <h2>Good Conduct Certificate Application</h2>
  <p>Please fill in the details below to begin your application for a Police Clearance Certificate (Certificate of Good Conduct)</p>
  <input id="firstName" placeholder="First Name" required>
  <input id="middleName" placeholder="Middle Name" required>
  <input id="surname" placeholder="Surname" required>
  <input id="idNumber" placeholder="ID Number" required>
  <input id="mobileNo" placeholder="Mobile No." required>
  <button onclick="submitApplication()">Submit Application</button>

  <div id="status-section" class="section">
    <h3>Status</h3>
    <p id="status-message">Checking...</p>
  </div>

  <div id="download-section" class="section hidden">
    <h3>Download Certificate</h3>
    <p id="certificate-title"></p>
    <p id="upload-time"></p>
    <a id="download-link" href="#" target="_blank"><button id="download-button">Download</button></a>
  </div>
</div>

<script>
const APP_ID = "9B2BFE67-C986-40AC-BFE8-BAE522A19615";
const API_KEY = "3379D979-5EA8-497C-B98B-0A996E643C7A";
Backendless.initApp(APP_ID, API_KEY);

let currentUser = null;

function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  Backendless.UserService.login(email, password, true)
    .then(user => {
      currentUser = user;
      onLoggedIn();
    })
    .catch(alert);
}

function register() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const user = new Backendless.User();
  user.email = email;
  user.password = password;
  Backendless.UserService.register(user)
    .then(() => alert("Registration successful. You can now log in."))
    .catch(alert);
}

function onLoggedIn() {
  document.getElementById("auth-section").classList.add("hidden");
  document.getElementById("app-section").classList.remove("hidden");
  checkStatus();
}

function submitApplication() {
  const appData = {
    firstName: document.getElementById("firstName").value,
    middleName: document.getElementById("middleName").value,
    surname: document.getElementById("surname").value,
    idNumber: document.getElementById("idNumber").value,
    email: currentUser.email,
    mobileNo: document.getElementById("mobileNo").value,
    status: "processing",
    paid: false,
    certificateId: "PCC-" + currentUser.objectId.substring(0, 8).toUpperCase(),
    user: { __type: "Pointer", objectId: currentUser.objectId, ___class: "Users" }
  };

  Backendless.Data.of("Applications").save(appData)
    .then(() => {
      alert("Application submitted!");
      checkStatus();
    })
    .catch(alert);
}

function checkStatus() {
  const userId = currentUser.objectId;
  const filePath = `/certificates/${userId}/certificate.pdf`;

  Backendless.Data.of("Applications")
    .findFirst({ where: "user.objectId='" + userId + "'" })
    .then(app => {
      Backendless.Files.exists(filePath).then(exists => {
        if (exists) {
          document.getElementById("status-message").innerText = "Certificate Generated!";
          document.getElementById("download-section").classList.remove("hidden");
          document.getElementById("certificate-title").innerText = app.certificateId || `PCC-${userId.substring(0,8).toUpperCase()}`;
          const now = new Date();
          document.getElementById("upload-time").innerText = now.toLocaleString();

          const downloadBtn = document.getElementById("download-button");
          const downloadLink = document.getElementById("download-link");

          if (app.paid) {
            downloadBtn.innerText = "Download Certificate";
            downloadLink.href = Backendless.Files.getFileURL(filePath);
          } else if (app.paymentLink) {
            downloadBtn.innerText = "Download (Pay First)";
            downloadLink.href = app.paymentLink;
          } else {
            downloadBtn.innerText = "Payment Required";
            downloadLink.href = "#";
            downloadLink.onclick = () => alert("Payment required. Please contact admin.");
          }
        } else {
          document.getElementById("status-message").innerText = "Certificate is being Processed! Wait for 1â€“2 working days from day of submission.";
        }
      });
    });
}
</script>
</body>
</html>
